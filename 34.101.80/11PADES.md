# 11 Формат PADES

## 11.1 Общие положения

PDF, переносимый формат данных, определен базовой спецификацией [PDF].
PDF описывает структуру цифровых документов, которые можно обрабатывать 
на разных платформах. На самом низком уровне PDF-документ представляет
собой последовательность байтов. Байты группируются в PDF-токены, токены -
в объекты. Объекты являются базовыми логическими элементами PDF, они 
задают структуру и содержание документа. Объекты могут вкладываться в 
другие объекты или ссылаться на другие объекты. Определены контейнеры двух 
типов: массив - упорядоченная последовательность объектов
и словарь - ассоциативная таблица пар объектов "ключ - значение".

<!-- todo: можно ли "октеты" вместо "байты"? (октеты в других разделах) -->

<!-- todo: Нужно ли говорить о токенах? -->

<!-- todo: А как задаются ссылки? Через имена? -->

<!-- todo: Синтаксис словаря (<<, >>)? [будет использоваться дальше] -->

В PDF предусмотрено расширение формата, т.е. добавление в него 
новых объектов и изменение существующих. Использованные расширения 
указываются в специальном словаре `extensions`.

<!-- todo: расширение формата или расширение документа?
изменение существующих? что это значит?
extensions -- имя словаря? М.б. "extension"? -->

PDF-документы могут подписываться. ЭЦП добавляется в документ, т.е.
является вложенной. Формат подписи описывается в подразделе 11.2. 
PAdES расширяет данный формат и налагает на него ряд ограничений.
Расширения и уточнения PAdES описываются в подразделах 11.3, 11.4.

## 11.2 Электронная цифровая подпись PDF

### 11.2.1 Словарь `Sig`

ЭЦП хранится внутри документа в специальном словаре `Sig`. ЭЦП является
расширенной: базовая ЭЦП (либо конверт с базовой ЭЦП) хранится в поле 
`Contents` словаря, атрибуты - в других полях.

<!-- todo: Во-первых, "конверт" не определено. Во-вторых,
атрибуты (в смысле атрибутов РЭЦП) могут храниться и в базовой ЭЦП. 
А есть еще атрибуты подписи PDF. И все это надо объяснить -->
 
Хэш-значение, используемое для выработки базовой ЭЦП, вычисляется от 
набора байтов, составляющих определенную часть документа. Способы задания 
целевого набора байтов описаны в пункте 11.3.4. 

Структура словаря `Sig` определена в таблице 1. В данной таблице, как и во
всех последующих таблицах раздела, в столбце "Обязательность" значение
"опц." означает, что данное поле при каких-то условиях может отсутствовать,
а значение "обяз." - то, что поле присутствует всегда и имеет непустое
значение.

**Таблица 1**. Словарь `Sig`

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | name | опц.      | `"Sig"`      |
| Filter      | name | обяз.     | Идентификатор обработчика подписи (см. пункт 11.3.5) |
| SubFilter   | name | опц.      | Идентификатор кодировки подписи (например, `"ETSI.CAdES.detached"`) |
| Contents    | byte string|обяз.| Базовая ЭЦП |
| Cert|array или byte string | опц.| Используется в случае, если СОК не содержится в конверте, хранящемся в `Contents`|
| ByteRange| array | обяз.         | Массив пар чисел, определяющий набор фрагментов документа, подлежащих включению к выработке хэш-значения|
| Reference| array| опц.           | Массив словарей `SigRef`, определяющих с помощью механизма трансформаций данные, которые будут подписываться     |
| Changes | array | опц.           | Специальным образом определяет изменения в документе, сделанные на момент подписания по сравнению с состоянием на момент предыдущего подписания (применяется в случае контрподписей)|
| Name    | text string| опц.      | Имя подписанта (если его нельзя получить из других источников, например из СОК)|
| M       | date     |   опц.      | Время подписания (если его нельзя получить из конверта, хранящегося в поле `Contents`)|
| Location| text string| опц.      | Место подписания (имя хоста, географическое расположение)|
| Reason  | text string| опц.      | Причины (мотивы), побудившие к подписанию (например, "Я согласен, ....") |
| ContactInfo| text string| опц.   | Контактные данные подписанта|
| V          | integer | опц.      | Версия формата словаря `Sig` (значение `1` означает что поле `Reference` обязательное, по умолчанию - `0`) |
| Prop_Build | dictionary| опц.    | Информация о состоянии системы во время подписания, например идентификатор обработчика подписи, версия програмного обеспечения, операционная система |
| Prop_AuthTime| integer| опц.     | Количество секунд, прошедших с момента последней аутентификации подписанта  |
| Prop_AuthType| name| опц.        | Метод аутентификации подписанта (например `"PIN"`, `"Password"`, `"Fingerprint"`) |

В этой и следующих таблицах используются следующие базовые типы PDF:

* integer - целое число;
* string - строка;
* name - строка, которая является именем (идентификатором) объекта;
* array - массив;
* dictionary - словарь;
* stream - поток, последовательность байт, подходящую для 
неструктурированных данных большого объема. 

<!-- todo: есть еще 
* Null - пустой объект;
* Boolean - логический объект, принимающий значение "true" или "false";
-->

<!-- todo: text string, byte string, date? -->

Словарь `Sig` может быть отыскан в документе различными способами. 
Так словарь `Sig` может быть значением определенного поля PDF-формы.
Или определенный объект документа может содержать ссылку на словарь.
Полная информация о вариантах размещения словаря `Sig` в документе PDF 
содержится в [PDF], подраздел 12.8. 

<!-- todo: отыскан?  -->

### 11.2.2 Задание подписываемых данных

Существует два способа задания той части документа, которая будет
подписываться.
 
Основной cпособ предполагает использование поля `ByteRange` словаря `Sig`.
Это поле представляет собой массив пар целых чисел, где каждая пара задает
фрагмент документа. Первое число пары является номером первого байта
фрагмента, второе число - длиной фрагмента. Заданные парами фрагменты
конкатенируются и подписываются.

Альтернативный способ состоит в использовании специального словаря
`SigRef`, в котором указывается так называемый метод трансформации.
Указанный метод применяется к документу или его части, на выходе получается
набор байтов, подлежащих подписанию. Подробности использования словаря
`SigRef` определены в [PDF], подраздел 12.8.

И в первом, и во втором случаях, обработчик подписи при выработке ЭЦП 
добивается, чтобы поле `Contents`, в котором содержится базовая ЭЦП, 
было исключено из подписываемых данных. 

<!-- todo: добивается? непонятно. исключает?  -->

### 11.2.3 Обработчик подписи

Обработчик подписи - это программа, которая отвечает за выработку, проверку
и дополнение РЭЦП PDF-документа. Подписи различных видов (например,
различных профилей) могут обрабатываться различными обработчиками.

Идентификатор обработчика (или его префикс) регистрируется в 
специальном реестре согласно требованиям [PDF], приложение E. 
Идентификатор может выбираться разработчиками программного обеспечения, 
с учетом требований уникальности и однозначности определения. 

<!-- todo: "или его префикс". Стоит ли об этом говорить? -->

В поле `Filter` словаря `Sig` указывается идентификатор обработчика подписи.
Это может быть либо обработчик, с помощью которого была выработана РЭЦП,
либо обработчик, который рекомендуется использовать при проверке и 
дополнении подписи. Несмотря на рекомендации, верификатор может 
использовать любой другой обработчик подписи, поддерживающий 
кодировку, указанную в поле `SubFilter` (см. п. 11.2.4). 

### 11.2.4 Кодировка подписи PDF

Кодировка подписи PDF - это формат значения поля `Contents` в словаре 
`Sig`.  Идентификатор кодировки указывается обработчиком подписи в поле 
`SubFilter` во время выработки ЭЦП. При последующей работе с подписью 
(дополнение, проверка) должен использоваться подходящий обработчик подписи - 
тот, который поддерживает заданную кодировку. 

Обычно при реализации подписи PDF используются такие кодировки, что поле
`Contents` содержит только базовую ЭЦП (без атрибутов). Однако в PAdES
используется кодировка CAdES, и это значит, что в `Contents` хранится не
просто базовая подпись, а конверт с РЭЦП в формате CAdES.

## 11.3 PAdES на основе CAdES

### 11.3.1 Основные положения

Формат PAdES расширяет базовый формат подписи PDF-документов. Расширение
фиксируется добавлением в словарь `extensions` следущего элемента:
 
```
<</ESIC
  <</BaseVersion /1.7
    /ExtensionLevel 2
  >>
>>
```

<!-- todo: синтаксис? не надо объяснить? -->

### 11.3.2 Кодировка CAdES

Кодировкой подписи для PAdES является формат CAdES. Это означает, что поле
`Contents` ДОЛЖНО содержать кодовое представление подписи CAdES одного из
профилей. Соответственно, в поле `SubFilter` ДОЛЖНА быть указана кодировка,
определяющая использование CAdES - `"ETSI.CAdES.detached"`.

При использовании CAdES многие атрибуты РЭЦП (например, СОК) содержатся 
сразу в конверте, хранящемся в поле `Contents`, и в соответствующих полях 
словаря `Sig` могут не указываться. Так поле `Cert` словаря `Sig` НЕ 
ДОЛЖНО использоваться.

Использование CAdES в PAdES имеет следующие особенности:
 
- атрибут `SigningTime` НЕ ДОЛЖЕН использоваться. Для определения времени 
служит поле `M` словаря `Sig`;
- атрибут `ContentType` ДОЛЖЕН принимать значение `"id-data"`;
- атрибут `ContentReference` НЕ ДОЛЖЕН использоваться;
- атрибут `ContentHints` НЕ ДОЛЖЕН использоваться;
- атрибут `SignerLocation` НЕ ДОЛЖЕН использоваться. Вместо него 
используется поле `Location` словаря `Sig`;
- атрибут `Countersignature` НЕ ДОЛЖЕН использоваться. Для управления 
контрподписями используется другой механизм, описанный в п. 11.4.4.

### 11.3.3 Ограничения на `ByteRange`

В PAdES разрешается использовать только 2 фрагмента в поле `ByteRange`
словаря `Sig`:

<!-- Хотя в ISO 32000-1 это только рекомендуется -->  

- от начала документа до поля `Contents` словаря `Sig`;
- от поля `Contents` до конца документа.

Таким образом, подписываются все байты, задающие содержимое документа и 
атрибуты РЭЦП, кроме байтов, составляющих значение базовой ЭЦП.

<!-- todo: в `Content` не только базовая ЭЦП, и речь не идет об атрибутах 
РЭЦП (они в `Content`) -->

### 11.3.4 Контрподписи

В PAdES контрподписи реализуются следующим образом. Каждый из подписантов 
создает в документе свой словарь `Sig`, содержимое которого заполняется в 
соответствии с текущим состоянием документа на момент подписания (PDF 
позволяет иметь несколько словарей `Sig`). 

Каждый из словарей задает свой `ByteRange`, так что фрагмент для каждой 
следующей подписи включает в себя фрагмент для предыдущей. 

<!-- todo: непонятно. Предыдущий ByteRange покрывает новый словарь?
Если нет, то противоречие с предыдущим пунктом. -->

### 11.3.5 Дополнительные объекты для долгосрочных подписей

### 11.3.5.1 Расширения

В долгосрочных РЭЦП профилей B-LT и B-LTA используются специальные
расширения формата PDF: `"Document security store"` (DSS) и `"Document
Time-stamp"` (DTS). Расширение DSS служит для хранения аттестатов, таких
как сертификаты УЦ, СОС, OCSP-ответы. Расширение DST служит для хранения
штампа времени. Аттестаты СЛЕДУЕТ хранить в объектах расширений, а не в 
атрибутах CAdES. При этом упрощается процесс дополнения подписи, 
учитывается специфика управления PDF-документами.

Объекты расширений DSS и DST создаются в документе в процессе дополнения 
подписи. Дополнений может быть несколько, при каждом из них в документе 
создается определенный набор объектов:

- при дополнении подписи до профиля B-LT создается набор объектов 
расширения DSS;
- при дополнении подписи профиля B-LT до подписи профиля B-LTA создаются 
объекты расширения DTS;
- при дополнении подписи профиля B-LTA до новой подписи профиля B-LTA 
создаются новые объекты DSS (с аттестатами для предыдущих штампов времени) 
и новые объекты DTS.

Таким образом, документ с подписью профиля B-LT ДОЛЖЕН содержать объекты 
расширения DSS, а документ с подписью профиля B-LTA ДОЛЖЕН содержать один 
или несколько наборов объектов DSS и DTS. 

Для указания на использование расширений DSS и DST в словарь 
`extensions` (см. пункт 11.2.3) необходимо добавить следущий элемент:
 
```
<</ESIC
  <</BaseVersion /1.7
    /ExtensionLevel 1
  >>
>>
```

#### 11.3.5.2 Расширение DSS

DSS представляет собой словарь внутри документа, служащий хранилищем для 
различных аттестатов. Аттестаты могут относиться к одной или нескольким 
подписям PAdES на основе CAdES, к одной или нескольким подписям XAdES в 
XML-вставках (см. подраздел 11.5), к встречающимся в документе штампам 
времени.
 
Расширение DSS описывается словарем `DSS` и словарями `Signature VRI`. 
Словарь `DSS` является единственным для всего документа, 
тогда как каждый из словарей `Signature VRI` служит для описания 
определенной подписи (если таковых в документе несколько, например в 
случае контрподписей). 
 
Поле `VRI` словаря `DSS` ДОЛЖНО храниться в специальном месте документа - 
так называемой инкрементальной секции (`"incremental section"`, см.  [PDF], 
п. 7.5.6). 
 
При проверке подписи, верификатор имеет несколько источников аттестатов. 
При поиске аттестатов РЕКОМЕНДУЕТСЯ последовательно проверять
сначала словари `Signature VRI`, затем словарь `DSS`,
затем данные, хранящиеся в `Contents`, или подписи XAdES в XML-вставках.
 
Структуры словарей `DSS` и `Signature VRI` определены в таблицах 2 и 3.

**Таблица 2**. Словарь `DSS`
 
| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | name | опц.      | DSS      |
| VRI      | dictionary | опц.     | словарь, ключами которого являются  SHA1-хэши подписей, значениями - соответствующие подписям словари `Signature VRI` |
| Certs|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает сертификат |
| OCSPs|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает OCSP-ответ |
| CRLs|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает СОС |

**Таблица 3**. Словарь `Signature VRI`

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | name | опц.      | VRI      |
| Cert|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает СОК |
| OCSP|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает OCSP-ответ |
| CRL|        array|  опц.| массив объектов (или ссылок на объекты) типа `Stream`, каждый из которых задает СОС |
|TU| date| опц. | время создания словаря |
|TS| stream| опц. | штамп времени, соответствующий времени создания данного `Signature VRI` |

<!-- todo: Stream или stream или `Stream` или `stream`? -->

#### 11.3.5.3 Расширение DST

Расширение DST задается словарем `DocTimeStamp`, который хранится в 
документе после словаря `DSS`.
 
Словарь `DocTimeStamp` представляет собой измененный словарь `Sig`.
Изменения описаны в таблице 4.

**Таблица 4.** Словарь `DocTimeStamp` (изменения относительно `Sig`)

| Ключ (поле) |  Тип |Обязательность| Значение  |
|-------------|------|-----------|-----------|
| Type        | name | опц.      | `"DocTimeStamp"`      |
| SubFilter   | name | обяз.     | Идентификатор кодировки (`"ETSI.RFC3161"`, или другой, определенный разработчиками системы) |
| Contents    | byte string | обяз.| Штамп времени в формате, определенном в СТБ 34.101.ts |
|V            | integer     | опц. | 0 | 

Словарь `DocTimeStamp` НЕ ДОЛЖЕН содержать поля `Cert`, `Reference`,
`Changes`, `R`, `Prop_AuthTime`, `Prop_AuthType`.

В словарь НЕ РЕКОМЕНДУЕТСЯ включать поля `Name`, `M`, `Location`, `Reason`,
`ContactInfo` (соответствующие данные присутствуют в конверте, хранящемся в
`Contents`). Верификатору СЛЕДУЕТ игнорировать перечисленные поля при
проверке подписи.

## 11.4 PAdES для XML-вставок

Документ PDF может содержать в себе данные в формате XML. Эти данные 
представляют собой XML-документ, вложенный в определенный объект PDF.

<!-- todo: убрал (чтобы не возиться с XFA):
Например, формы для заполнения могут быть описаны с помощью XFA (XML 
Forms Architecture).  
-->

Вложенный XML-документ МОЖЕТ подписываться. Его подпись XAdES также будет
вложена в PDF-документ как часть XML-документа. 

Уже подписанный XML-документ МОЖЕТ быть повторно подписан как часть 
PDF-документа. При этом ДОЛЖНА вырабатываться описанная выше подпись PAdES 
на основе CAdES.

Для долгосрочных подписей XAdES (профили B-LT и B-LTA) МОГУТ 
использоваться расширения DSS и DST, описанные в пункте 11.3.5. Тогда 
объекты этих расширений ДОЛЖНЫ включать аттестаты для подписей XAdES. 

